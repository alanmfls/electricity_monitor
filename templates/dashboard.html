{% extends "base.html" %}

{% block title %}Dashboard - Electricity Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt text-primary"></i> Electricity Monitoring Dashboard
            <small class="text-muted">- Apartment {{ apartment_number }}</small>
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="metric-card">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-bolt text-warning fa-2x"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h5 class="mb-1">Voltage</h5>
                    <h3 class="mb-0" id="voltage">{{ "%.2f"|format(data.voltage) }} V</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-stream text-info fa-2x"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h5 class="mb-1">Current</h5>
                    <h3 class="mb-0" id="current">{{ "%.2f"|format(data.current) }} A</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-fire text-danger fa-2x"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h5 class="mb-1">Power</h5>
                    <h3 class="mb-0" id="power">{{ "%.2f"|format(data.power) }} W</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="power-card text-center">
            <h2 class="mb-3">
                <i class="fas fa-chart-line"></i> Real-time Power Consumption
            </h2>
            <div class="row">
                <div class="col-md-3">
                    <h4>Voltage</h4>
                    <h2 id="main-voltage">{{ "%.2f"|format(data.voltage) }} V</h2>
                </div>
                <div class="col-md-3">
                    <h4>Current</h4>
                    <h2 id="main-current">{{ "%.2f"|format(data.current) }} A</h2>
                </div>
                <div class="col-md-3">
                    <h4>Power</h4>
                    <h2 id="main-power">{{ "%.2f"|format(data.power) }} W</h2>
                </div>
                <div class="col-md-3">
                    <h4>Last Update</h4>
                    <h6 id="last-update">
                        {% if data.timestamp %}
                            {{ data.timestamp.strftime('%H:%M:%S') }}
                        {% else %}
                            No data
                        {% endif %}
                    </h6>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <h5><i class="fas fa-building"></i> Apartment {{ apartment_number }} - MQTT Topic: electricity/building/floor/{{ apartment_number }}</h5>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-light btn-lg" onclick="saveReading()">
                    <i class="fas fa-save"></i> Save Current Reading
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> Connection Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>MQTT Broker:</strong> <span id="mqtt-status" class="badge bg-success">Connected</span></p>
                        <p><strong>Data Source:</strong> Real-time MQTT feed</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Calculation:</strong> Power = Voltage Ã— Current</p>
                        <p><strong>Update Frequency:</strong> Real-time</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update data every 2 seconds
    setInterval(function() {
        fetch('/api/power-data')
            .then(response => response.json())
            .then(data => {
                document.getElementById('voltage').textContent = data.voltage.toFixed(2) + ' V';
                document.getElementById('current').textContent = data.current.toFixed(2) + ' A';
                document.getElementById('power').textContent = data.power.toFixed(2) + ' W';
                
                document.getElementById('main-voltage').textContent = data.voltage.toFixed(2) + ' V';
                document.getElementById('main-current').textContent = data.current.toFixed(2) + ' A';
                document.getElementById('main-power').textContent = data.power.toFixed(2) + ' W';
                
                if (data.timestamp) {
                    const date = new Date(data.timestamp);
                    document.getElementById('last-update').textContent = date.toLocaleTimeString();
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('mqtt-status').textContent = 'Disconnected';
                document.getElementById('mqtt-status').className = 'badge bg-danger';
            });
    }, 2000);

    function saveReading() {
        fetch('/api/save-reading', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Reading saved successfully!');
            } else {
                alert('Error saving reading: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving reading');
        });
    }
</script>
{% endblock %}
